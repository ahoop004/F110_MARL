meta:
  name: gaplock_blocker

scenario:
  env:
    map: Budapest_map
    
    # map: line2
    seed: 42
    max_steps: 5000
    lidar_beams: 108
    terminate_on_any_done: true
    vehicle_params:
      v_max: 1.0
      v_min: -1.0
      length: 0.32
      width: 0.225
    spawn_points:
      - spawn_3
      - spawn_1

  main:
    mode: eval
    eval_episodes: 1
    save_eval_rollouts: false
    eval_rollout_dir: eval_rollouts
    wandb:
      enabled: false

  agents:
    car_0:
      trainable: false
      algorithm:
        name: blocker
        params:
          target_agent: car_1
          target_forward: 0.6         # longitudinal distance (m) to hold ahead of defender
          target_lateral: 0.025       # signed lateral offset (m): negative keeps blocker on inside wall
          speed_offset: -0.01        # bias slower than defender so it can pin without overshooting
          forward_gain: 0.05         # how aggressively it closes the longitudinal gap
          lateral_gain: 0.09         # lateral correction strength (lower = gentler pinch)
          heading_gain: 0.07         # keeps heading aligned with defender
          speed_gain: 0.05         # responsiveness when matching speed
          max_speed: 0.8
          max_steer: 0.18
          pressure_margin: 0.22       # slack before wall guardrails engage
          pressure_gain: 0.3         # slowdown when squeezing toward wall
          cruise_speed: 0.55         # minimum speed when comfortably ahead
          catchup_limit: 0.01        # cap on longitudinal catch-up boost
          damping_gain: 0.45          # smoothing on steering corrections (0=no damping, 1=heavy)
          accel_limit: 0.3            # limit on speed command increase per step
          decel_limit: 0.4            # limit on speed command decrease per step
          guard_speed_penalty: 0.2    # how much to slow when breaching wall guard
          min_block_speed: 0.2        # never go below this, so blocker doesn't stall
          separation_guard_distance: 0.4   # start braking if lead falls below this (m)
          separation_guard_speed: 0.15    # crawl speed when FTG is about to rear-end
          pressure_ramp_steps: 60     # steps to hold formation before tightening the squeeze
          pressure_ramp_delta: 0.001   # amount to move inward each ramp event (m)
          pressure_ramp_limit: 0.025   # maximum additional inward offset applied by ramp
          band_forward_tol: 0.2       # forward error (m) allowed while counting toward ramp
          band_lateral_tol: 0.04      # lateral error (m) allowed while counting toward ramp
          alignment_bias_deg: 15.0     # final heading clamp toward wall
          alignment_bias_enabled: true
          alignment_lateral_window: 0.01
          alignment_wall_margin: 0.30
          alignment_lidar_threshold: 0.25
          alignment_lidar_front_fraction: 0.4
          alignment_lidar_side_fraction: 0.15
          debug_lidar: true
      wrappers:
        - factory: obs
          params:
            components:
              - id: lidar
                type: lidar
                params:
                  beams: 108
                  max_range: 30.0
                  normalize: false

    car_1:
      trainable: false
      algorithm:
        name: follow_gap
        params:
          max_distance: 30.0
          window_size: 2
          bubble_radius: 1
          max_steer: 0.35
          min_speed: 0.2
          max_speed: 0.8
          steering_gain: 0.4
          fov_deg: 270
          normalized: true
          steer_smooth: 0.35
          center_bias_gain: 0.25
          inside_bias_gain: 0.2
          crawl_steer_ratio: 0.35
          steering_speed_scale: 1.0
          preview_horizon: 1.5
          preview_samples: 7
          dwa_samples: 5
          dwa_horizon: 0.5
          dwa_heading_weight: 0.15
          enhanced_gap_scoring: true
          gap_score_width_weight: 1.0
          gap_score_clearance_weight: 1.2
          gap_score_center_weight: 0.5
          gap_score_curvature_weight: 0.2
          u_shape_enabled: false
